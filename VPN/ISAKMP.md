# IKE와 ISAKMP

- 두 개의 장비가 보안통신을 하기 위해서는 데이터를 암호화하고 무결성을 확인하기 위한 보안 프로토콜이 정해져야한다.
- 또한, 통신 상대방이 공격자가 아닌지 판단할 수 있는 인증(Authentication)과정도 거쳐야한다.
- 이와 같은 일을 하는 것이 `IKE와 ISAKMP`이다.

```markdown
ISAKMP는 이와 같은 일을 하는 절차를 명시한 프로토콜.

IKE는 ISAKMP가 명시한 각 절차에서 필요한 프로토콜의 종류와 사용방법을 정의한다.
```

### IKEv2란?

- 위에서 언급한 IKE와 ISAKMP는 동일한 부분이 너무 많고, 관계도 애매하여 IKE와 ISAKMP를 혼용하여 표현하는 경우가 허다하다.
- 이와같은 문제들 때문에 현재 주로 사용되고 있는 IKEv1 대신 2005년 12월에 발표되고 2010년 9월에 개정된 `IKEv2` 가 생겨났다.
- IKEv2는 IKE와 ISAKMP를 통합하였고 ISAKMP라는 용어를 사용하지도 않는다.
- 기본적으로 IKEv1을 사용하고 있는 Cisco의 IOS에서는 관련 명령어들이 `crypto isakmpfh`로 시작한다.

---

## IKE의 동작방식

- IKE Phase 1 에서는 IKE Phase 2 에서 사용할 보안정책인 ISAKMP SA를 결정한다. 그리고 각 보안 알고리즘에서 사용할 Key를 생성하고 상대 장비를 인증한다.
- IKE Phase 2 에서는 실제 데이터 송수신을 위해서 필요한 보안정책인 IPSEC SA를 결정한다.

## IKE Phase 1 동작 방식 ( Main Mode )

1. 통신을 시작하는 송신측에서 ISAKMP SA를 제안한다. (인증 방식, 암호화 방식 등등..)

---

1. 이를 수신한 수신측에서는 자신에게 설정된 ISAKMP SA 세트들과 비교하여 일치하는 SA 세트가 있으면 상대가 제안한 것과 동일한 SA를 전송하여 상대의 제안을 수락했다고 알려준다.

2-1. 이 떄, SA 세트들은 사전에 미리 설정이 되어있어야한다.

---

1. 그 다음, 디피-헬먼 알고리즘을 사용하여 양측에서 이후 과정부터 암호화 및 해싱에 사용할 Key를 생성한다. 이를 위하여 송신자 측 라우터는 자신의 공개키와 임의로 만든 Nonce 수를 수신측 라우터에게 전송한다.

---

1. 또한, 수신측도 마찬가지로 자신의 공개키와 Nonce를 송신측 라우터에게 전송한다. 이후 두 라우터에서는 자신의 개인키와 각각 수신한 Nonce를 이용하여 동일한 대칭키를 계산해 낸 후 이것을 패킷의 암호화 및 해시코드 계산용 키로 사용한다.

---

- 결과론적으로 디피-헬먼 알고리즘을 사용하여 보안성이 없는 네트워크로 연결된 양쪽 라우터들 끼리만 아는 대칭키를 생성한다.
- 이처럼 디피-헬먼 알고리즘 자체는 비 대칭키를 사용하지만 이를 이용해 생성한 대칭키는 양측에서 동일한 대칭키 이다.
- 이 대칭키는 ISAKMP 세션과 IPSEC이 종료될 때 까지 사용된다.

---

1. 지금부터는 1,2에서 결정한 암호화/해싱 알고리즘과 3,4에서 계산된 Key를 사용하여 패킷을 암호화 시키고, 무결성 확인용 해시코드를 만들어 첨부한다. 
- 5에서는 두 장비가 서로 인증하는 절차를 진행한다.
- R1(송신측)의 자신의 ID와 인증정보를 암호화 하여 R2(수신측)에게 전송한다.
- PSK 방식으로 인증할 떈, 자신의 ID, 암호를 이용하여 해시코드를 만들고 이를 전송한다.
- R2는 PSK,R1의 ID, 동일한 해싱 알고리즘을 사용하여 R1으로부터 전송된 해시코드를 계산한다.
- 수신한 해시코드를 비교하고 동일한 값이면 인증에 성공한다.
- (PSK 값이 아니라 디지털 인증서를 사용한다면 인증 서버를 통한 인증 과정을 거친다.)

---

1. R2도 자신의 ID값, 인증정보를 R1에게 암호화 하여 전송한다. R1은 R2와 동일한 해싱 알고리즘을 적용하여 해시코드를 계산한다. R2에게서 받은 해시코드를 비교하고 동일한 값이면 인증에 성공한다.

---

- 이렇게 6단계를 거쳐서 실제 데이터 보호를 위한 IKE Phase 2 보안정책을 협상할 준비가 완료된다.
- 이처럼 6단계를 거쳐서 IKE Phase 1 보안정책을 협상하는 방법은 `Main Mode`라고 한다.
- 하지만 3개의 패킷만 교환하여 IKE Phase 1을 끝내는 방법이 있는데, 이 방법을                                      `Aggressive Mode` 라고 한다.

## Aggressive Mode

### 첫 번째 패킷

- ISAKMP SA 제안, 디피-헬먼 Key 계산에 필요한 정보 및 ID까지 전부 담아서 보낸다.

### 두 번째 패킷

- 응답 장비인 R2에서 선택된 ISAKMP SA, 디시-헬먼 Key 계산에 필요한 정보와 함께 R1을 인증하겠다는 메시지가 포함된다.

### 세 번째 패킷

- R1이 인증 메시지를 전송하여 IKE Phase1 협상이 종료된다.

하지만 이 방법은 협상이 빠른 시간내에 종료되지만, ID가 공격자에게 노출되므로 거의 Main Mode를 사용한다.

---

- IKE Phase 1 협상이 끝나면 실제 데이터를 보호하기 위한 IPSEC SA를 협상하는 IKE Phase 2가 시작된다.

## IKE Phase 2 동작 방식

1. R1이 실제 데이터를 보호하기 위한 정책, 즉 IPSEC SA를 R2에게 제안한다. 
    1. 포함되는 정보 : 암호화/해싱 알고리즘, 보호대상 네트워크 정보, VPN 동작 모드 등…
2. 이를 수신한 R2는 자신이 지원가능한 IPSEC SA 세트를 선택하여 R1에게 다시 알려준다.
3. R1은 R2가 동의한 IPSEC SA 정책에 대해서 수신확인 메시지를 보낸다.
- 이처럼 3단계를 거쳐 IPSEC 보안정책을 협상하는 것을 `Quick Mode` 라고 한다.
- 이렇게 총 9 단계를 거쳐서 ISAKMP 세션 즉, IKE 세션 설립이 완료된다.

### 기타 정보

- ISAKMP 세션에서 송수신되는 패킷은 전부 UDP 500번을 사용한다.
- 따라서, IPSEC VPN 장비 사이에 방화벽을 사용하고 있다면 UDP 500번을 허용하도록 설정해야한다.